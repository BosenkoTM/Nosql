## Практическая работа 3. Анализ данных в Apache Cassandra

#### Цели:
- Развернуть и настроить Apache Cassandra с использованием Docker.
- Изучить основы работы с Cassandra и CQL.
- Выполнить анализ данных, используя запросы CQL.
- Выполнить индивидуальное задание для углубленного изучения.

### ШАГ 1. Получение Cassandra с помощью Docker

Для начала необходимо скачать Docker и установить его на ваш компьютер. Затем, чтобы загрузить образ Cassandra, выполните следующую команду:

```bash
docker pull cassandra:latest
```

Это скачает последнюю версию Apache Cassandra, готовую к запуску.

---

### ШАГ 2. Запуск Cassandra

Создадим Docker-сеть и запустим контейнер с Cassandra:

```bash
docker network create cassandra
docker run --rm -d --name cassandra --hostname cassandra --network cassandra cassandra
```

После выполнения этих команд Cassandra будет запущена в контейнере, и мы сможем подключаться к ней через созданную сеть.

---

### ШАГ 3. Создание файлов

Для работы с Cassandra используем язык запросов CQL, который по синтаксису похож на SQL. Создайте файл с именем `data.cql`, который будет содержать следующие команды для создания ключевого пространства, таблицы и вставки данных:

```cql
-- Create a keyspace
CREATE KEYSPACE IF NOT EXISTS store WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : '1' };

-- Create a table
CREATE TABLE IF NOT EXISTS store.shopping_cart (
  userid text PRIMARY KEY,
  item_count int,
  last_update_timestamp timestamp
);

-- Insert some data
INSERT INTO store.shopping_cart (userid, item_count, last_update_timestamp)
VALUES ('9876', 2, toTimeStamp(now()));

INSERT INTO store.shopping_cart (userid, item_count, last_update_timestamp)
VALUES ('1234', 5, toTimeStamp(now()));
```

Этот скрипт создаст ключевое пространство `store`, затем таблицу `shopping_cart` для хранения данных о корзинах покупок, и вставит пару записей.

---

### ШАГ 4. Загрузка данных с помощью CQLSH

Чтобы загрузить данные в Cassandra с помощью CQLSH, используем команду Docker:

```bash
docker run --rm --network cassandra -v "$(pwd)/data.cql:/scripts/data.cql" -e CQLSH_HOST=cassandra -e CQLSH_PORT=9042 -e CQLVERSION=3.4.6 nuvo/docker-cqlsh
```

Убедитесь, что сервер Cassandra уже запущен, иначе загрузка данных может завершиться с ошибкой.

---

### ШАГ 5. Интерактивный CQLSH

Если вы хотите работать с Cassandra в интерактивном режиме, можно запустить оболочку CQL:

```bash
docker run --rm -it --network cassandra nuvo/docker-cqlsh cqlsh cassandra 9042 --cqlversion='3.4.5'
```

После подключения вы сможете выполнять команды CQL напрямую, например, выполнять запросы на чтение данных.

---

### ШАГ 6. Чтение данных

Чтобы убедиться, что данные были успешно загружены в таблицу, выполните запрос:

```cql
SELECT * FROM store.shopping_cart;
```

Это вернет все строки из таблицы `shopping_cart`.

---

### ШАГ 7. Запись новых данных

Теперь добавим еще одну запись в таблицу:

```cql
INSERT INTO store.shopping_cart (userid, item_count) VALUES ('4567', 20);
```

---

### ШАГ 8. Очистка

Когда работа завершена, не забудьте удалить контейнер и сеть Docker:

```bash
docker kill cassandra
docker network rm cassandra
```

---

### Групповое индивидуальное задание

После выполнения всех шагов вам нужно будет выполнить следующие задачи для углубленного изучения и практики.

#### Задание 1. Добавьте дополнительную колонку в таблицу
Измените таблицу `shopping_cart`, добавив колонку `total_price`, которая будет хранить общую стоимость всех товаров в корзине для каждого пользователя. Напишите CQL-запрос, который обновит таблицу и вставит несколько новых значений с расчетом стоимости (предположим, что цена товара фиксированная).

**Подсказка:**

```cql
ALTER TABLE store.shopping_cart ADD total_price decimal;
```

#### Задание 2. Напишите запрос на выборку данных с сортировкой
Напишите CQL-запрос, который возвращает все корзины (все строки из таблицы), отсортированные по количеству товаров в корзине (по убыванию). Убедитесь, что вы используете правильный синтаксис сортировки.

**Подсказка:**

```cql
SELECT * FROM store.shopping_cart ORDER BY item_count DESC;
```

#### Задание 3. Добавьте индексы для ускорения поиска
Для того чтобы ускорить поиск по полям, таким как `item_count` или `userid`, создайте индекс на эти поля. Напишите CQL-запрос для создания индекса и объясните, почему индексы могут быть полезны в Cassandra.

**Подсказка:**

```cql
CREATE INDEX ON store.shopping_cart(item_count);
CREATE INDEX ON store.shopping_cart(userid);
```

---

### Индивидуальные задания для студентов

**Вариант 1**

1. Создайте новое ключевое пространство в Cassandra с репликацией типа `NetworkTopologyStrategy` и репликацией на два узла.
2. Добавьте новую таблицу в пространство `store` для хранения информации о заказах с полями: `order_id`, `userid`, `order_date`, `total_amount`.
3. Напишите CQL-запрос для получения всех заказов для пользователя с `userid = '1234'` отсортированных по `order_date` в порядке убывания.

---

**Вариант 2**

1. Создайте таблицу для хранения информации о продуктах в магазине с полями: `product_id`, `product_name`, `price`, `stock_quantity`.
2. Вставьте 5 записей в таблицу продуктов с разными значениями для каждого поля.
3. Напишите CQL-запрос для поиска всех товаров с ценой более 50 единиц, отсортированных по убыванию `price`.

---

**Вариант 3**

1. Создайте ключевое пространство с именем `inventory` и используйте стратегию репликации `SimpleStrategy` с фактором репликации 3.
2. Создайте таблицу для хранения истории транзакций (покупок) с полями: `transaction_id`, `userid`, `product_id`, `transaction_date`, `quantity`.
3. Напишите запрос для вывода всех транзакций, совершенных в январе 2025 года.

---

**Вариант 4**

1. Создайте таблицу с данными о сотрудниках компании с полями: `employee_id`, `name`, `department`, `hire_date`, `salary`.
2. Добавьте индексы на поля `department` и `hire_date` для ускорения поиска.
3. Напишите запрос для получения всех сотрудников, работающих в отделе "HR", за последние 5 лет.

---

**Вариант 5**

1. Создайте ключевое пространство для хранения данных о книгах в библиотеке.
2. Создайте таблицу для хранения информации о книгах с полями: `book_id`, `title`, `author`, `publish_year`, `genre`.
3. Напишите CQL-запрос для поиска всех книг, написанных автором "J.K. Rowling".

---

**Вариант 6**

1. Создайте таблицу с данными о клиентских заказах с полями: `order_id`, `userid`, `product_name`, `order_date`, `amount`.
2. Вставьте 10 записей в таблицу с разными датами заказов.
3. Напишите запрос, который выберет все заказы, сделанные в марте 2025 года.

---

**Вариант 7**

1. Создайте ключевое пространство с именем `sales` и репликацией на один узел.
2. Создайте таблицу для хранения информации о продажах с полями: `sale_id`, `product_name`, `sale_date`, `amount`.
3. Напишите запрос для поиска всех продаж за последний месяц.

---

**Вариант 8**

1. Создайте таблицу для хранения информации о пользователей с полями: `userid`, `username`, `email`, `signup_date`, `last_login`.
2. Добавьте индекс на поле `last_login`.
3. Напишите запрос для поиска всех пользователей, которые не заходили на сайт более 6 месяцев.

---

**Вариант 9**

1. Создайте таблицу для хранения информации о заказах, где будут храниться следующие поля: `order_id`, `userid`, `order_date`, `order_status`.
2. Вставьте несколько записей, используя разные статусы заказов.
3. Напишите запрос для получения всех заказов со статусом "Shipped", сделанных в 2024 году.

---

**Вариант 10**

1. Создайте ключевое пространство с репликацией `SimpleStrategy` и создайте таблицу для хранения данных о клиентах с полями: `client_id`, `name`, `address`, `phone_number`, `email`.
2. Добавьте несколько записей с различными значениями.
3. Напишите запрос для поиска всех клиентов, чьи адреса начинаются на букву "A".

---

**Вариант 11**

1. Создайте таблицу для хранения информации о студентских курсах с полями: `course_id`, `course_name`, `teacher`, `start_date`, `end_date`.
2. Вставьте 5 записей с различными курсами.
3. Напишите запрос для вывода всех курсов, начинающихся после 1 января 2025 года.

---

**Вариант 12**

1. Создайте таблицу для хранения информации о фильмах с полями: `movie_id`, `title`, `director`, `release_year`, `genre`.
2. Добавьте индекс на поле `release_year`.
3. Напишите запрос для получения всех фильмов, выпущенных после 2010 года.

---

**Вариант 13**

1. Создайте таблицу для хранения информации о поставках с полями: `supply_id`, `supplier_id`, `product_name`, `supply_date`, `quantity`.
2. Вставьте несколько записей о поставках.
3. Напишите запрос для поиска всех поставок, сделанных в августе 2025 года.

---

**Вариант 14**

1. Создайте ключевое пространство с репликацией `NetworkTopologyStrategy` с репликацией на два узла.
2. Создайте таблицу для хранения информации о сотрудниках с полями: `employee_id`, `first_name`, `last_name`, `date_of_birth`, `department`.
3. Напишите запрос для поиска сотрудников из отдела "Engineering" с датой рождения после 1985 года.

---

**Вариант 15**

1. Создайте таблицу для хранения информации о покупках с полями: `purchase_id`, `product_id`, `purchase_date`, `quantity`.
2. Вставьте несколько записей, с разными датами покупки.
3. Напишите запрос для получения всех покупок в январе 2025 года.

---

**Вариант 16**

1. Создайте таблицу для хранения информации о курсах с полями: `course_id`, `course_name`, `instructor`, `start_date`, `duration`.
2. Напишите запрос для вывода всех курсов, длительность которых больше 4 месяцев.

---

**Вариант 17**

1. Создайте таблицу с данными о клиентах интернет-магазина с полями: `customer_id`, `name`, `email`, `address`, `phone_number`.
2. Напишите запрос для поиска клиентов с именем, начинающимся на "A".

---

**Вариант 18**

1. Создайте таблицу для хранения информации о платежах с полями: `payment_id`, `userid`, `payment_date`, `amount`.
2. Вставьте несколько записей о платежах.
3. Напишите запрос для получения всех платежей, сделанных в декабре 2025 года.

---

**Вариант 19**

1. Создайте таблицу для хранения данных о членах клуба с полями: `member_id`, `name`, `join_date`, `membership_type`.
2. Напишите запрос для поиска всех членов, которые стали частью клуба после 1 января 2024 года.

---

**Вариант 20**

1. Создайте таблицу для хранения данных о спортивных событиях с полями: `event_id`, `event_name`, `event_date`, `location`.
2. Напишите запрос для вывода всех событий, происходящих в мае 2025 года.

---

**Вариант 21**

1. Создайте таблицу для хранения информации о товарах с полями: `product_id`, `product_name`, `category`, `price`, `quantity_in_stock`.
2. Напишите запрос для поиска всех товаров с ценой от 10 до 100 единиц.

---

**Вариант 22**

1. Создайте таблицу для хранения информации о транзакциях с полями: `transaction_id`, `userid`, `transaction_date`, `amount`.
2. Напишите запрос для получения всех транзакций за март 2025 года с суммой больше 100 единиц.

---

**Вариант 23**

1. Создайте таблицу для хранения данных о студенческих оценках с полями: `student_id`, `subject`, `grade`, `exam_date`.
2. Напишите запрос для вывода всех оценок по предмету "Mathematics".

---

**Вариант 24**

1. Создайте таблицу для хранения информации о мероприятиях с полями: `event_id`, `event_name`, `event_date`, `location`, `participants_count`.
2. Напишите запрос для получения всех мероприятий с количеством участников более 50.

---

**Вариант 25**

1. Создайте таблицу для хранения данных о сотрудниках с полями: `employee_id`, `name`, `position`, `hire_date`, `salary`.
2. Напишите запрос для поиска всех сотрудников с зарплатой выше 50000 единиц.

---
